<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <!--
   _
  | |
  | |__   __ _  ___ ______ _ __ ___   __ _ _ __
  | '_ \ / _` |/ __|______| '_ ` _ \ / _` | '_ \
  | | | | (_| | (__       | | | | | | (_| | | | |
  |_| |_|\__,_|\___|      |_| |_| |_|\__,_|_| |_|
  -->
  <title>hac-man</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #ed4f7e;

    }

    #overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      font-family: "Courier New", sans-serif;
      color: #37bec0;
    }

    #score {
      padding: 5px 10px;
      font-size: 2em;
      font-weight: bold;
    }

    #winModal {
      display: none;
      width: 300px;
      margin: 200px auto;
      padding: 20px;
      border: 3px solid #2121de;
      border-radius: 10px;
      background-color: #000;
      text-align: center;
    }

    button {
      border: 0;
      background-color: yellow;
      padding: 5px;
      border-radius: 5px;
      font-size: 1.1em;
      cursor: pointer;
    }
  </style>
  <script src="libs/phaser.min.js"></script>
  <script src="libs/howler.min.js"></script>
</head>
<body>

<div id="overlay">
  <div id="score">0</div>
  <div id="winModal">
    <h3>Woot Woot!</h3>
    <p>You Won The Hack!</p>
    <p>Amazeballs.</p>
    <p>
      <button id="restartBtn">Restart</button>
    </p>
  </div>
</div>

<script type="text/javascript">

  var INVINCIBLE_TIME = 5000;

  var scoreEl = document.getElementById('score'),
      winModalEl = document.getElementById('winModal'),
      restartBtn = document.getElementById('restartBtn');

  var game = new Phaser.Game(448, 496, Phaser.AUTO);

  var Pacman = function (game) {

    this.map = null;
    this.gameLayer = null;
    this.badguys = [];
    this.powerUps = [];
    this.pacman = null;

    this.safetile = 14;
    this.gridsize = 16;

    this.speed = 200;
    this.threshold = 3;

    this.marker = new Phaser.Point();
    this.turnPoint = new Phaser.Point();

    this.directions = [null, null, null, null, null];
    this.opposites = [Phaser.NONE, Phaser.RIGHT, Phaser.LEFT, Phaser.DOWN, Phaser.UP];

    this.current = Phaser.NONE;
    this.turning = Phaser.NONE;

    this.isPacmanInvincible = false;
    this.invincibilityTimeout = null;

    this.score = 0;

  };

  Pacman.prototype = {

    init: function () {

      this.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;
      this.scale.pageAlignHorizontally = true;
      this.scale.pageAlignVertically = true;

      Phaser.Canvas.setImageRenderingCrisp(this.game.canvas);

      this.physics.startSystem(Phaser.Physics.ARCADE);

      restartBtn.onclick = this.restartGame.bind(this);

    },

    preload: function () {

      //  We need this because the assets are on Amazon S3
      this.load.image('dot', 'assets/dot.png', 20, 20);
      this.load.image('pizza', 'assets/pizza.png', 32, 32);
      this.load.image('tiles', 'assets/pacman-tiles.png');
      this.load.spritesheet('pacman', 'assets/pacman.png', 32, 32);
      this.load.spritesheet('ian', 'assets/pacman-ian.png', 32, 32);
      this.load.spritesheet('niall', 'assets/pacman-niall.png', 32, 32);
      this.load.spritesheet('clo', 'assets/pacman-clo.png', 32, 32);
      this.load.spritesheet('toby', 'assets/pacman-toby.png', 32, 32);
      this.load.spritesheet('mark', 'assets/pacman-mark.png', 32, 32);
      this.load.tilemap('map', 'assets/pacman-map.json', null, Phaser.Tilemap.TILED_JSON);

      //  Needless to say, graphics (C)opyright Namco
    },
    create: function () {

      this.createGameLayer();
      this.createBadGuys();
      this.createPacman();

    },

    createGameLayer: function () {

      this.map = this.add.tilemap('map');
      this.map.addTilesetImage('pacman-tiles', 'tiles');

      this.gameLayer = this.map.createLayer('Pacman');

      this.dots = this.add.physicsGroup();

      this.map.createFromTiles(
          7,                 // tiles index to create sprites from
          this.safetile,     // replacements tile index to change a converted tile to
          'dot',             // sprite key
          this.gameLayer,    // layer to operate on
          this.dots);        // group to add sprites to

      //  The dots will need to be offset by 6px to put them back in the middle of the grid
      this.dots.setAll('x', 6, false, false, 1);
      this.dots.setAll('y', 6, false, false, 1);

      this.powerUps.push(this.createPowerUp(1, 1, 'pizza'));
      this.powerUps.push(this.createPowerUp(26, 1, 'pizza'));
      this.powerUps.push(this.createPowerUp(1, 29, 'pizza'));
      this.powerUps.push(this.createPowerUp(26, 29, 'pizza'));

      //  Pacman should collide with everything except the safe tile
      this.map.setCollisionByExclusion([this.safetile], true, this.gameLayer);
    },

    createBadGuys: function () {
      this.badguys.push(this.createBadGuy(104, 328, 'ian'));
      this.badguys.push(this.createBadGuy(170, 136, 'niall'));
      this.badguys.push(this.createBadGuy(136, 86, 'clo'));
      this.badguys.push(this.createBadGuy(328, 326, 'toby'));
      this.badguys.push(this.createBadGuy(344, 472, 'mark'));
    },

    createPacman: function () {

      //  Position Pacman at grid location 14x17 (the +8 accounts for his anchor)
      this.pacman = this.add.sprite((14 * 16) + 8, (17 * 16) + 8, 'pacman', 0);
      this.pacman.anchor.set(0.5);
      this.pacman.animations.add('munch', [0, 1, 2, 1], 20, true);

      this.physics.arcade.enable(this.pacman);
      this.pacman.body.setSize(16, 16, 0, 0);


      this.cursors = this.input.keyboard.createCursorKeys();

      this.pacman.play('munch');
      this.movePacman(Phaser.LEFT);

    },

    checkKeys: function () {

      if (this.cursors.left.isDown && this.current !== Phaser.LEFT) {
        this.checkDirection(Phaser.LEFT);
      }
      else if (this.cursors.right.isDown && this.current !== Phaser.RIGHT) {
        this.checkDirection(Phaser.RIGHT);
      }
      else if (this.cursors.up.isDown && this.current !== Phaser.UP) {
        this.checkDirection(Phaser.UP);
      }
      else if (this.cursors.down.isDown && this.current !== Phaser.DOWN) {
        this.checkDirection(Phaser.DOWN);
      }
      else {
        //  This forces them to hold the key down to turn the corner
        this.turning = Phaser.NONE;
      }

    },

    checkDirection: function (turnTo) {

      if (this.turning === turnTo || this.directions[turnTo] === null || this.directions[turnTo].index !== this.safetile) {
        //  Invalid direction if they're already set to turn that way
        //  Or there is no tile there, or the tile isn't index 1 (a floor tile)
        return;
      }

      //  Check if they want to turn around and can
      if (this.current === this.opposites[turnTo]) {
        this.movePacman(turnTo);
      }
      else {
        this.turning = turnTo;
        this.turnPoint.x = (this.marker.x * this.gridsize) + (this.gridsize / 2);
        this.turnPoint.y = (this.marker.y * this.gridsize) + (this.gridsize / 2);
      }


    },

    turn: function () {

      var cx = Math.floor(this.pacman.x);
      var cy = Math.floor(this.pacman.y);

      //  This needs a threshold, because at high speeds you can't turn because the coordinates skip past
      if (!this.math.fuzzyEqual(cx, this.turnPoint.x, this.threshold) || !this.math.fuzzyEqual(cy, this.turnPoint.y, this.threshold)) {
        return false;
      }

      //  Grid align before turning
      this.pacman.x = this.turnPoint.x;
      this.pacman.y = this.turnPoint.y;

      this.pacman.body.reset(this.turnPoint.x, this.turnPoint.y);

      this.movePacman(this.turning);

      this.turning = Phaser.NONE;


      return true;

    },

    move: function (character, direction, speed) {

      if (direction === Phaser.LEFT || direction === Phaser.UP) {
        speed = -speed;
      }

      if (direction === Phaser.LEFT || direction === Phaser.RIGHT) {
        character.body.velocity.x = speed;
      }
      else {
        character.body.velocity.y = speed;
      }

      //  Reset the scale and angle (Pacman is facing to the right in the sprite sheet)
      character.scale.x = 1;
      character.angle = 0;

      if (direction === Phaser.LEFT) {
        character.scale.x = -1;
      }
      else if (direction === Phaser.UP) {
        character.angle = 270;
      }
      else if (direction === Phaser.DOWN) {
        character.angle = 90;
      }
    },

    movePacman: function (direction) {
      this.move(this.pacman, direction, this.speed);
      this.current = direction;
    },

    eatDot: function (pacman, dot) {

      dot.kill();

      this.setScoreText(this.score++);

      if (this.dots.total === 0) {
        this.onWinGame();
      }

    },

    eatPowerUp: function (pacman, powerUp) {

      powerUp.kill();

      this.goInvincible();

      this.setScoreText(this.score += 50);

    },

    changeBadGuyDirection: function (badGuy, layer) {
      var r = Math.random();
      var direction =
        r < 0.25
        ? Phaser.UP
        : r < 0.5
          ? Phaser.RIGHT
          : r < 0.75
            ? Phaser.DOWN
            : Phaser.LEFT;
      this.move(badGuy, direction, 100);
    },

    goInvincible: function() {

      console.log('Invincible! :)');
      this.isPacmanInvincible = true;

      if ( this.invincibilityTimeout ) {
        // Cancel previous timer
        clearTimeout( this.invincibilityTimeout );
      }

      this.setBadGuysColour(0x42caf1);

      this.invincibilityTimeout = setTimeout(function() {

        console.log('Fallible :(');

        this.isPacmanInvincible = false;
        this.setBadGuysColour(0xffffff);

      }.bind(this), INVINCIBLE_TIME);

    },

    setBadGuysColour: function(colour) {

      for (var i = 0; i < this.badguys.length; i++ ) {
        var badGuy = this.badguys[i];
        badGuy.tint = colour;
      }

    },

    update: function () {

      this.physics.arcade.collide(this.pacman, this.gameLayer);
      for (var i = 0; i < this.badguys.length; i++) {
        var badGuy = this.badguys[i];
        this.physics.arcade.collide(badGuy, this.gameLayer, this.changeBadGuyDirection.bind(this));
      }
      this.physics.arcade.overlap(this.pacman, this.dots, this.eatDot, null, this);

      // TODO try to switch array to a group so we don't have to loop through
      for (var i = 0; i < this.powerUps.length; i++ ) {
        var powerUp = this.powerUps[i];
        game.physics.arcade.collide(this.pacman, powerUp, this.eatPowerUp.bind(this));
        //game.debug.body(powerUp, 'red', false);
        //game.debug.spriteBounds(powerUp, 'pink', false);
      }

      this.marker.x = this.math.snapToFloor(Math.floor(this.pacman.x), this.gridsize) / this.gridsize;
      this.marker.y = this.math.snapToFloor(Math.floor(this.pacman.y), this.gridsize) / this.gridsize;

      //  Update our grid sensors
      this.directions[1] = this.map.getTileLeft(this.gameLayer.index, this.marker.x, this.marker.y);
      this.directions[2] = this.map.getTileRight(this.gameLayer.index, this.marker.x, this.marker.y);
      this.directions[3] = this.map.getTileAbove(this.gameLayer.index, this.marker.x, this.marker.y);
      this.directions[4] = this.map.getTileBelow(this.gameLayer.index, this.marker.x, this.marker.y);

      this.checkKeys();

      if (this.turning !== Phaser.NONE) {
        this.turn();
      }

    },

    setScoreText: function (score) {
      scoreEl.innerHTML = score;
    },

    onWinGame: function () {

      winModalEl.style.display = 'block';

    },

    restartGame: function () {

      winModalEl.style.display = 'none';

      this.dots.callAll('revive');
      this.score = 0;
      this.setScoreText(this.score);
    },

    createBadGuy: function (x, y, key) {
      var badGuy = game.add.sprite(x, y, key, 0);
      badGuy.anchor.set(0.5);
      badGuy.name = key;
      game.physics.arcade.enable(badGuy);
      badGuy.body.setSize(8, 8, 0, 0);
      this.move(badGuy, Phaser.RIGHT, 100);
      return badGuy;
    },

    createPowerUp: function (x, y, key) {
      var powerUp = game.add.sprite(x * 16 + 4, y * 16, key, 0);
      powerUp.scale.setTo(0.8, 0.7);
      game.physics.arcade.enable(powerUp);
      return powerUp;
    }

  };

  game.state.add('Game', Pacman, true);

</script>

</body>
</html>
